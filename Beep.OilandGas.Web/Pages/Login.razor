@page "/login"
@layout AccountLayout
@inject NavigationManager NavigationManager
@inject Beep.OilandGas.Web.Theme.IThemeProvider ThemeProvider
@inject ISnackbar Snackbar
@using Beep.OilandGas.Web.Theme

<PageTitle>Login - Beep Oil & Gas</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-12">
    <MudPaper Elevation="3" Class="pa-8">
        <MudStack Spacing="4" AlignItems="AlignItems.Center">
            <img src="@(_branding.LogoUrl ?? "/imgs/BeepOGDM.png")" alt="@(_branding.AppName ?? "Beep Oil & Gas")" style="height: 60px; width: auto; margin-bottom: 16px;" />
            <MudText Typo="Typo.h4">@(_branding.LoginTitle ?? "Login")</MudText>
            <MudText Typo="Typo.body2" Align="Align.Center" Style="color: var(--mud-palette-text-secondary);">
                @(_branding.LoginWelcomeMessage ?? "Sign in to access your dashboard")
            </MudText>
            
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Class="mt-8" />
            <MudText Typo="Typo.body2" Align="Align.Center" Style="color: var(--mud-palette-text-secondary);">
                Redirecting to login...
            </MudText>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private BrandingConfig _branding = new();

    protected override void OnInitialized()
    {
        _branding = ThemeProvider.GetBranding();
    }
    
    protected override async Task OnInitializedAsync()
    {
        // The /authentication/login endpoint will handle the OIDC challenge
        // which redirects to IdentityServer with the client_id parameter
        var returnUrl = NavigationManager.Uri.Contains("returnUrl") 
            ? NavigationManager.Uri.Split("returnUrl=")[1] 
            : "/dashboard";
        
        // Use the authentication endpoint which triggers OIDC challenge
        NavigationManager.NavigateTo($"/authentication/login?returnUrl={Uri.EscapeDataString(returnUrl)}", forceLoad: true);
    }
}

