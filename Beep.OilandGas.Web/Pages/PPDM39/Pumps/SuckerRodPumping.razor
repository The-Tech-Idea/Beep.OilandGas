@page "/ppdm39/pumps/suckerrodpumping"
@using Beep.OilandGas.Models.DTOs
@using Beep.OilandGas.Models.Core.Interfaces
@using Beep.OilandGas.Web.Services
@inject IPumpServiceClient PumpService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Sucker Rod Pumping</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Sucker Rod Pumping Design & Analysis</MudText>

    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-4">Design Sucker Rod Pump System</MudText>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="@_wellUWI" Label="Well UWI" Variant="Variant.Outlined" Required="true" />
            <MudNumericField @bind-Value="@_wellDepth" Label="Well Depth (ft)" Variant="Variant.Outlined" />
            <MudNumericField @bind-Value="@_tubingDiameter" Label="Tubing Diameter (in)" Variant="Variant.Outlined" />
            <MudNumericField @bind-Value="@_wellheadPressure" Label="Wellhead Pressure (PSI)" Variant="Variant.Outlined" />
            <MudNumericField @bind-Value="@_bottomHolePressure" Label="Bottom Hole Pressure (PSI)" Variant="Variant.Outlined" />
            <MudNumericField @bind-Value="@_desiredFlowRate" Label="Desired Flow Rate (BBL/D)" Variant="Variant.Outlined" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DesignPump" Disabled="@_isDesigning">
                Design Pump System
            </MudButton>
        </MudStack>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
        }

        @if (_pumpDesign != null)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Pump Design Results</MudText>
                <MudStack Spacing="2">
                    <MudText>Design ID: @_pumpDesign.DesignId</MudText>
                    <MudText>Pump Depth: @_pumpDesign.PumpDepth.ToString("F2") ft</MudText>
                    <MudText>Pump Size: @_pumpDesign.PumpSize.ToString("F2")</MudText>
                    <MudText>Stroke Length: @_pumpDesign.StrokeLength.ToString("F2") in</MudText>
                    <MudText>Strokes Per Minute: @_pumpDesign.StrokesPerMinute.ToString("F2")</MudText>
                </MudStack>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="SaveDesign">
                    Save Design
                </MudButton>
            </MudPaper>
        }
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">Performance Analysis</MudText>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="@_pumpId" Label="Pump ID" Variant="Variant.Outlined" />
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="AnalyzePerformance" Disabled="@_isAnalyzing">
                Analyze Performance
            </MudButton>
        </MudStack>

        @if (_performance != null)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Performance Results</MudText>
                <MudStack Spacing="2">
                    <MudText>Flow Rate: @_performance.FlowRate.ToString("F2") BBL/D</MudText>
                    <MudText>Efficiency: @_performance.Efficiency.ToString("F2")%</MudText>
                    <MudText>Power Consumption: @_performance.PowerConsumption.ToString("F2") HP</MudText>
                </MudStack>
            </MudPaper>
        }
    </MudPaper>
</MudContainer>

@code {
    private string _wellUWI = string.Empty;
    private decimal _wellDepth = 5000;
    private decimal _tubingDiameter = 2.5m;
    private decimal _wellheadPressure = 100;
    private decimal _bottomHolePressure = 2000;
    private decimal _desiredFlowRate = 500;
    private string _pumpId = string.Empty;
    private bool _isDesigning = false;
    private bool _isAnalyzing = false;
    private bool _isLoading = false;
    private SuckerRodPumpDesignDto? _pumpDesign;
    private SuckerRodPumpPerformanceDto? _performance;
    private string? _currentUserId = "system";

    private async Task DesignPump()
    {
        if (string.IsNullOrEmpty(_wellUWI))
        {
            Snackbar.Add("Please enter a Well UWI", Severity.Warning);
            return;
        }

        _isDesigning = true;
        try
        {
            var wellProperties = new SuckerRodPumpWellPropertiesDto
            {
                WellDepth = _wellDepth,
                TubingDiameter = _tubingDiameter,
                WellheadPressure = _wellheadPressure,
                BottomHolePressure = _bottomHolePressure,
                DesiredFlowRate = _desiredFlowRate
            };

            _pumpDesign = await PumpService.DesignSuckerRodPumpSystemAsync(_wellUWI, wellProperties);
            Snackbar.Add("Pump design completed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error designing pump: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDesigning = false;
        }
    }

    private async Task SaveDesign()
    {
        if (_pumpDesign == null)
        {
            Snackbar.Add("No design to save", Severity.Warning);
            return;
        }

        try
        {
            var saved = await PumpService.SaveSuckerRodPumpDesignAsync(_pumpDesign, _currentUserId);
            if (saved)
            {
                Snackbar.Add("Pump design saved successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving design: {ex.Message}", Severity.Error);
        }
    }

    private async Task AnalyzePerformance()
    {
        if (string.IsNullOrEmpty(_pumpId))
        {
            Snackbar.Add("Please enter a Pump ID", Severity.Warning);
            return;
        }

        _isAnalyzing = true;
        try
        {
            _performance = await PumpService.AnalyzeSuckerRodPumpPerformanceAsync(_pumpId);
            Snackbar.Add("Performance analysis completed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error analyzing performance: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }
}

