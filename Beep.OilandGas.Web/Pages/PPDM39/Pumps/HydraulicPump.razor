@page "/ppdm39/pumps/hydraulicpump"
@using Beep.OilandGas.Models.DTOs
@using Beep.OilandGas.Web.Services
@inject IPumpServiceClient PumpService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Hydraulic Pump</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Hydraulic Pump Design & Analysis</MudText>

    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-4">Design Hydraulic Pump System</MudText>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="@_wellUWI" Label="Well UWI" Variant="Variant.Outlined" Required="true" />
            <MudSelect @bind-Value="@_pumpType" Label="Pump Type" Variant="Variant.Outlined">
                <MudSelectItem Value="JetPump">Jet Pump</MudSelectItem>
                <MudSelectItem Value="PistonPump">Piston Pump</MudSelectItem>
                <MudSelectItem Value="CentrifugalPump">Centrifugal Pump</MudSelectItem>
            </MudSelect>
            <MudNumericField @bind-Value="@_wellDepth" Label="Well Depth (ft)" Variant="Variant.Outlined" />
            <MudNumericField @bind-Value="@_desiredFlowRate" Label="Desired Flow Rate (BBL/D)" Variant="Variant.Outlined" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DesignPump" Disabled="@_isDesigning">
                Design Pump System
            </MudButton>
        </MudStack>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
        }

        @if (_pumpDesign != null)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Pump Design Results</MudText>
                <MudStack Spacing="2">
                    <MudText>Design ID: @_pumpDesign.DesignId</MudText>
                    <MudText>Pump Depth: @_pumpDesign.PumpDepth.ToString("F2") ft</MudText>
                    <MudText>Pump Size: @_pumpDesign.PumpSize.ToString("F2")</MudText>
                    <MudText>Operating Pressure: @_pumpDesign.OperatingPressure.ToString("F2") PSI</MudText>
                    <MudText>Flow Rate: @_pumpDesign.FlowRate.ToString("F2") BBL/D</MudText>
                    <MudText>Efficiency: @_pumpDesign.Efficiency.ToString("F2")%</MudText>
                </MudStack>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="SaveDesign">
                    Save Design
                </MudButton>
            </MudPaper>
        }
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-4">Pump Performance Analysis</MudText>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="@_pumpId" Label="Pump ID" Variant="Variant.Outlined" />
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="AnalyzePerformance" Disabled="@_isAnalyzing">
                Analyze Performance
            </MudButton>
        </MudStack>

        @if (_performanceAnalysis != null)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Performance Analysis Results</MudText>
                <MudStack Spacing="2">
                    <MudText>Current Flow Rate: @_performanceAnalysis.CurrentFlowRate.ToString("F2") BBL/D</MudText>
                    <MudText>Current Efficiency: @_performanceAnalysis.CurrentEfficiency.ToString("F2")%</MudText>
                    <MudText>Recommended Flow Rate: @_performanceAnalysis.RecommendedFlowRate.ToString("F2") BBL/D</MudText>
                </MudStack>
            </MudPaper>
        }
    </MudPaper>
</MudContainer>

@code {
    private string _wellUWI = string.Empty;
    private string _pumpType = "JetPump";
    private decimal _wellDepth = 5000;
    private decimal _desiredFlowRate = 500;
    private string _pumpId = string.Empty;
    private bool _isDesigning = false;
    private bool _isAnalyzing = false;
    private bool _isLoading = false;
    private HydraulicPumpDesignDto? _pumpDesign;
    private PumpPerformanceAnalysisDto? _performanceAnalysis;
    private string? _currentUserId = "system";

    private async Task DesignPump()
    {
        if (string.IsNullOrEmpty(_wellUWI))
        {
            Snackbar.Add("Please enter a Well UWI", Severity.Warning);
            return;
        }

        _isDesigning = true;
        try
        {
            _pumpDesign = await PumpService.DesignHydraulicPumpSystemAsync(_wellUWI, _pumpType, _wellDepth, _desiredFlowRate);
            Snackbar.Add("Pump design completed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error designing pump: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDesigning = false;
        }
    }

    private async Task SaveDesign()
    {
        if (_pumpDesign == null)
        {
            Snackbar.Add("No design to save", Severity.Warning);
            return;
        }

        try
        {
            var saved = await PumpService.SaveHydraulicPumpDesignAsync(_pumpDesign, _currentUserId);
            if (saved)
            {
                Snackbar.Add("Pump design saved successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving pump design: {ex.Message}", Severity.Error);
        }
    }

    private async Task AnalyzePerformance()
    {
        if (string.IsNullOrEmpty(_pumpId))
        {
            Snackbar.Add("Please enter a Pump ID", Severity.Warning);
            return;
        }

        _isAnalyzing = true;
        try
        {
            _performanceAnalysis = await PumpService.AnalyzeHydraulicPumpPerformanceAsync(_pumpId);
            Snackbar.Add("Performance analysis completed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error analyzing performance: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isAnalyzing = false;
        }
    }
}

