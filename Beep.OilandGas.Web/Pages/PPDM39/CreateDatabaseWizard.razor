@page "/ppdm39/create-database"
@inject ApiClient ApiClient
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IProgressTrackingClient ProgressClient
@using Beep.OilandGas.Web.Components
@using Beep.OilandGas.ApiService.Models
@using Beep.OilandGas.Models.DTOs
@using System.Net.Http.Json

<PageTitle>Create PPDM Database</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
    <MudText Typo="Typo.h4" Class="mb-4">Create PPDM39 Database</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Follow the steps below to create a new PPDM39 database and add it to your connections
    </MudText>

    <MudStepper @bind-ActiveStep="@_activeStep" Variant="Variant.Outlined" Color="Color.Primary" Class="mb-4">
        <!-- Step 1: Database Type Selection -->
        <MudStep Title="Database Type" Icon="@Icons.Material.Filled.Storage">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Step 1: Select Database Type</MudText>
                <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
                    Choose the database type you want to use for your PPDM39 database
                </MudText>

                <MudSelect T="string" 
                          Label="Database Type" 
                          Variant="Variant.Outlined"
                          @bind-Value="@_selectedDatabaseType"
                          Required="true"
                          RequiredError="Database type is required">
                    @foreach (var dbType in _availableDatabaseTypes)
                    {
                        <MudSelectItem Value="@dbType">@dbType</MudSelectItem>
                    }
                </MudSelect>

                @if (!string.IsNullOrEmpty(_selectedDatabaseType))
                {
                    <MudAlert Severity="Severity.Info" Class="mt-4">
                        Selected: <strong>@_selectedDatabaseType</strong>
                        @if (_defaultPorts.ContainsKey(_selectedDatabaseType))
                        {
                            <MudText Typo="Typo.body2" Class="mt-2">
                                Default Port: <strong>@_defaultPorts[_selectedDatabaseType]</strong>
                            </MudText>
                        }
                    </MudAlert>
                }
            </MudPaper>
        </MudStep>

        <!-- Step 2: Connection Configuration -->
        <MudStep Title="Connection Settings" Icon="@Icons.Material.Filled.Settings" Disabled="@(string.IsNullOrEmpty(_selectedDatabaseType))">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Step 2: Configure Connection</MudText>
                <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
                    Enter your database connection details
                </MudText>

                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="@_connectionName" 
                                     Label="Connection Name" 
                                     Variant="Variant.Outlined" 
                                     Required="true"
                                     RequiredError="Connection name is required" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="@_host" 
                                     Label="Host/Server" 
                                     Variant="Variant.Outlined" 
                                     Required="true"
                                     Placeholder="localhost"
                                     RequiredError="Host is required" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField T="int?" 
                                     @bind-Value="@_port" 
                                     Label="Port" 
                                     Variant="Variant.Outlined"
                                     HelperText="@GetPortHelperText()" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="@_database" 
                                     Label="Database Name" 
                                     Variant="Variant.Outlined" 
                                     Required="true"
                                     RequiredError="Database name is required" />
                    </MudItem>
                    @if (_selectedDatabaseType != "SQLite")
                    {
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="@_schema" 
                                         Label="Schema (Optional)" 
                                         Variant="Variant.Outlined"
                                         HelperText="Leave empty to use default schema" />
                        </MudItem>
                    }
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="@_username" 
                                     Label="Username" 
                                     Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="@_password" 
                                     Label="Password" 
                                     Variant="Variant.Outlined"
                                     InputType="InputType.Password" />
                    </MudItem>
                </MudGrid>

                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          Class="mt-4"
                          StartIcon="@Icons.Material.Filled.CheckCircle"
                          OnClick="TestConnection"
                          Disabled="@(_isTestingConnection || !CanTestConnection())">
                    @if (_isTestingConnection)
                    {
                        <text>Testing Connection...</text>
                    }
                    else
                    {
                        <text>Test Connection</text>
                    }
                </MudButton>

                @if (_connectionTestResult != null)
                {
                    <MudAlert Severity="@(_connectionTestResult.Success ? Severity.Success : Severity.Error)" Class="mt-4">
                        @_connectionTestResult.Message
                        @if (!string.IsNullOrEmpty(_connectionTestResult.ErrorDetails))
                        {
                            <MudText Typo="Typo.caption">@_connectionTestResult.ErrorDetails</MudText>
                        }
                    </MudAlert>
                }
            </MudPaper>
        </MudStep>

        <!-- Step 3: Script Options -->
        <MudStep Title="Script Options" Icon="@Icons.Material.Filled.List" Disabled="@(_connectionTestResult == null || !_connectionTestResult.Success)">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Step 3: Configure Script Execution</MudText>
                <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
                    Configure which scripts to execute during database creation
                </MudText>

                @if (_isLoadingScripts)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    <MudText>Discovering scripts...</MudText>
                }
                else if (_discoveredScripts != null && _discoveredScripts.Any())
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        Found <strong>@_discoveredScripts.Count</strong> scripts to execute
                    </MudAlert>

                    <MudGrid>
                        <MudItem xs="12">
                            <MudCheckBox T="bool" @bind-Value="@_executeAllScripts" Label="Execute All Scripts (Recommended)" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox T="bool" @bind-Value="@_executeConsolidatedScripts" Label="Execute Consolidated Scripts (TAB.sql, PK.sql, etc.)" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox T="bool" @bind-Value="@_executeIndividualScripts" Label="Execute Individual Table Scripts" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox T="bool" @bind-Value="@_executeOptionalScripts" Label="Execute Optional Scripts (TCM, CCM, SYN, GUID)" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox T="bool" @bind-Value="@_continueOnError" Label="Continue on Error" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox T="bool" @bind-Value="@_enableRollback" Label="Enable Rollback on Error" />
                        </MudItem>
                    </MudGrid>

                    <MudExpansionPanels Elevation="0" Variant="Variant.Outlined" MultiExpansion="false" Class="mt-4">
                        <MudExpansionPanel Text="Script Categories" Icon="@Icons.Material.Filled.Category">
                            <MudText Typo="Typo.body2" Class="mb-2">Filter by module/category:</MudText>
                            @if (_scriptCategories != null && _scriptCategories.Any())
                            {
                                <MudStack Spacing="2">
                                    @foreach (var category in _scriptCategories)
                                    {
                                        <MudCheckBox T="bool" 
                                                    @bind-Value="@category.IsSelected" 
                                                    Label="@($"{category.CategoryName} ({category.ScriptCount} scripts)")" />
                                    }
                                </MudStack>
                            }
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="Script Types" Icon="@Icons.Material.Filled.Code">
                            <MudText Typo="Typo.body2" Class="mb-2">Filter by script type:</MudText>
                            <MudStack Spacing="2">
                                @foreach (var scriptType in _availableScriptTypes)
                                {
                                    <MudCheckBox T="bool" 
                                                @bind-Value="@scriptType.IsSelected" 
                                                Label="@scriptType.Name" />
                                }
                            </MudStack>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        No scripts found. Please check the scripts path configuration.
                    </MudAlert>
                }
            </MudPaper>
        </MudStep>

        <!-- Step 4: Database Creation -->
        <MudStep Title="Create Database" Icon="@Icons.Material.Filled.Build" Disabled="@(_discoveredScripts == null || !_discoveredScripts.Any())">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Step 4: Create Database</MudText>
                <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
                    Execute scripts to create the PPDM39 database structure
                </MudText>

                @if (!_isCreatingDatabase)
                {
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              Size="Size.Large"
                              StartIcon="@Icons.Material.Filled.PlayArrow"
                              OnClick="StartDatabaseCreation"
                              Disabled="@(!CanStartCreation())">
                        Start Database Creation
                    </MudButton>
                }
                else
                {
                    <MudStack Spacing="3">
                        <MudProgressLinear Color="Color.Primary" 
                                         Value="@_creationProgress" 
                                         Variant="Variant.Determinate"
                                         Class="mb-2" />
                        <MudText Typo="Typo.body1">
                            Progress: <strong>@_creationProgress.ToString("F1")%</strong>
                            (@_currentCompletedScripts of @_totalScripts scripts)
                        </MudText>
                        @if (!string.IsNullOrEmpty(_currentScript))
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Current: <strong>@_currentScript</strong>
                            </MudText>
                        }
                        <MudText Typo="Typo.body2">
                            Successful: <MudChip Size="Size.Small" Color="Color.Success">@_successfulScripts</MudChip>
                            Failed: <MudChip Size="Size.Small" Color="Color.Error">@_failedScripts</MudChip>
                        </MudText>

                        @if (!string.IsNullOrEmpty(_creationLog))
                        {
                            <MudExpansionPanels Elevation="0" Variant="Variant.Outlined" Class="mt-4">
                                <MudExpansionPanel Text="Execution Log" Icon="@Icons.Material.Filled.Description">
                                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;">
                                        @_creationLog
                                    </MudText>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        }

                        @if (_creationResult != null && _creationResult.Success)
                        {
                            <MudAlert Severity="Severity.Success" Class="mt-4">
                                Database creation completed successfully!
                                <MudText Typo="Typo.body2" Class="mt-2">
                                    Total Duration: @_creationResult.TotalDuration.TotalMinutes.ToString("F2") minutes
                                </MudText>
                            </MudAlert>
                        }
                        else if (_creationResult != null && !_creationResult.Success)
                        {
                            <MudAlert Severity="Severity.Error" Class="mt-4">
                                Database creation failed: @_creationResult.ErrorMessage
                            </MudAlert>
                        }
                    </MudStack>
                }
            </MudPaper>
        </MudStep>

        <!-- Step 5: Save Connection -->
        <MudStep Title="Save Connection" Icon="@Icons.Material.Filled.Save" Disabled="@(_creationResult == null || !_creationResult.Success)">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Step 5: Save Connection</MudText>
                <MudText Typo="Typo.body2" Class="mb-4" Color="Color.Secondary">
                    Save the connection to ConfigEditor and optionally set it as current
                </MudText>

                <MudPaper Elevation="1" Class="pa-4 mb-4">
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Connection Details</MudText>
                    <MudStack Spacing="2">
                        <MudText><strong>Connection Name:</strong> @_connectionName</MudText>
                        <MudText><strong>Database Type:</strong> @_selectedDatabaseType</MudText>
                        <MudText><strong>Host:</strong> @_host</MudText>
                        <MudText><strong>Port:</strong> @(_port?.ToString() ?? "Default")</MudText>
                        <MudText><strong>Database:</strong> @_database</MudText>
                        @if (!string.IsNullOrEmpty(_schema))
                        {
                            <MudText><strong>Schema:</strong> @_schema</MudText>
                        }
                    </MudStack>
                </MudPaper>

                <MudCheckBox T="bool" @bind-Value="@_setAsCurrent" Label="Set as Current Connection" Class="mb-4" />

                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          Size="Size.Large"
                          StartIcon="@Icons.Material.Filled.Save"
                          OnClick="SaveConnection"
                          Disabled="@(_isSavingConnection)">
                    @if (_isSavingConnection)
                    {
                        <text>Saving...</text>
                    }
                    else
                    {
                        <text>Save Connection</text>
                    }
                </MudButton>

                @if (_saveResult != null)
                {
                    <MudAlert Severity="@(_saveResult.Success ? Severity.Success : Severity.Error)" Class="mt-4">
                        @_saveResult.Message
                        @if (_saveResult.Success)
                        {
                            <MudButton Variant="Variant.Text" 
                                     Color="Color.Primary" 
                                     Class="mt-2"
                                     OnClick="NavigateToDatabaseManagement">
                                Go to Database Management
                            </MudButton>
                        }
                    </MudAlert>
                }
            </MudPaper>
        </MudStep>
    </MudStepper>

    <MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween" Class="mt-4">
        <MudButton Variant="Variant.Text" 
                  Color="Color.Default"
                  OnClick="NavigateToDatabaseManagement">
            Cancel
        </MudButton>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" 
                      Color="Color.Default"
                      OnClick="GoToPreviousStep"
                      Disabled="@(_activeStep == 0)">
                Previous
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary"
                      OnClick="GoToNextStep"
                      Disabled="@(!CanProceedToNextStep())">
                Next
            </MudButton>
        </MudStack>
    </MudStack>
</MudContainer>

@code {
    private int _activeStep = 0;
    
    // Step 1: Database Type
    private string? _selectedDatabaseType;
    private List<string> _availableDatabaseTypes = new() { "SqlServer", "PostgreSQL", "MySQL", "MariaDB", "Oracle", "SQLite" };
    private Dictionary<string, int> _defaultPorts = new()
    {
        { "SqlServer", 1433 },
        { "PostgreSQL", 5432 },
        { "MySQL", 3306 },
        { "MariaDB", 3306 },
        { "Oracle", 1521 },
        { "SQLite", 0 }
    };

    // Step 2: Connection
    private string _connectionName = string.Empty;
    private string _host = "localhost";
    private int? _port;
    private string _database = string.Empty;
    private string? _schema;
    private string? _username;
    private string? _password;
    private bool _isTestingConnection = false;
    private ConnectionTestResult? _connectionTestResult;

    // Step 3: Scripts
    private bool _isLoadingScripts = false;
    private List<ScriptInfoDto>? _discoveredScripts;
    private bool _executeAllScripts = true;
    private bool _executeConsolidatedScripts = true;
    private bool _executeIndividualScripts = true;
    private bool _executeOptionalScripts = false;
    private bool _continueOnError = false;
    private bool _enableRollback = false;
    private List<ScriptCategoryDto>? _scriptCategories;
    private List<ScriptTypeDto>? _availableScriptTypes;

    // Step 4: Creation
    private bool _isCreatingDatabase = false;
    private decimal _creationProgress = 0;
    private int _currentCompletedScripts = 0;
    private int _totalScripts = 0;
    private string _currentScript = string.Empty;
    private int _successfulScripts = 0;
    private int _failedScripts = 0;
    private string _creationLog = string.Empty;
    private DatabaseCreationResultDto? _creationResult;
    private string? _executionId;
    private System.Threading.Timer? _progressTimer;

    // Step 5: Save
    private bool _isSavingConnection = false;
    private bool _setAsCurrent = false;
    private SaveConnectionResult? _saveResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadDatabaseTypes();
        InitializeScriptTypes();
    }

    protected override void Dispose()
    {
        _progressTimer?.Dispose();
        base.Dispose();
    }

    private async Task LoadDatabaseTypes()
    {
        try
        {
            _availableDatabaseTypes = await ApiClient.GetAsync<List<string>>("/api/ppdm39/setup/database-types") 
                ?? _availableDatabaseTypes;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading database types: {ex.Message}", Severity.Warning);
        }
    }

    private void InitializeScriptTypes()
    {
        _availableScriptTypes = new List<ScriptTypeDto>
        {
            new() { Name = "TAB", IsSelected = true },
            new() { Name = "PK", IsSelected = true },
            new() { Name = "FK", IsSelected = true },
            new() { Name = "CK", IsSelected = true },
            new() { Name = "OUOM", IsSelected = true },
            new() { Name = "UOM", IsSelected = true },
            new() { Name = "RQUAL", IsSelected = true },
            new() { Name = "RSRC", IsSelected = true },
            new() { Name = "TCM", IsSelected = false },
            new() { Name = "CCM", IsSelected = false },
            new() { Name = "SYN", IsSelected = false },
            new() { Name = "GUID", IsSelected = false }
        };
    }

    private string GetPortHelperText()
    {
        if (string.IsNullOrEmpty(_selectedDatabaseType) || !_defaultPorts.ContainsKey(_selectedDatabaseType))
            return "Enter port number";
        return $"Default: {_defaultPorts[_selectedDatabaseType]}";
    }

    private bool CanTestConnection()
    {
        return !string.IsNullOrEmpty(_host) && 
               !string.IsNullOrEmpty(_database) &&
               !string.IsNullOrEmpty(_selectedDatabaseType);
    }

    private async Task TestConnection()
    {
        if (!CanTestConnection())
        {
            Snackbar.Add("Please fill in all required connection fields", Severity.Warning);
            return;
        }

        _isTestingConnection = true;
        _connectionTestResult = null;

        try
        {
            var config = BuildConnectionConfig();
            _connectionTestResult = await ApiClient.PostAsync<ConnectionConfig, ConnectionTestResult>(
                "/api/ppdm39/setup/test-connection", config);

            if (_connectionTestResult?.Success == true)
            {
                Snackbar.Add("Connection test successful", Severity.Success);
                // Auto-load scripts after successful connection test
                await LoadScripts();
            }
            else
            {
                Snackbar.Add($"Connection test failed: {_connectionTestResult?.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error testing connection: {ex.Message}", Severity.Error);
            _connectionTestResult = new ConnectionTestResult
            {
                Success = false,
                Message = ex.Message
            };
        }
        finally
        {
            _isTestingConnection = false;
        }
    }

    private async Task LoadScripts()
    {
        if (string.IsNullOrEmpty(_selectedDatabaseType))
            return;

        _isLoadingScripts = true;
        try
        {
            _discoveredScripts = await ApiClient.GetAsync<List<ScriptInfoDto>>(
                $"/api/ppdm39/setup/discover-scripts/{_selectedDatabaseType}");

            if (_discoveredScripts != null && _discoveredScripts.Any())
            {
                // Group by category
                _scriptCategories = _discoveredScripts
                    .GroupBy(s => s.Module ?? "Unknown")
                    .Select(g => new ScriptCategoryDto
                    {
                        CategoryName = g.Key,
                        ScriptCount = g.Count(),
                        IsSelected = true
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading scripts: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingScripts = false;
        }
    }

    private ConnectionConfig BuildConnectionConfig()
    {
        return new ConnectionConfig
        {
            DatabaseType = _selectedDatabaseType ?? string.Empty,
            ConnectionName = _connectionName,
            Host = _host,
            Port = _port ?? (_defaultPorts.ContainsKey(_selectedDatabaseType ?? "") ? _defaultPorts[_selectedDatabaseType!] : 0),
            Database = _database,
            Schema = _schema,
            Username = _username,
            Password = _password
        };
    }

    private bool CanStartCreation()
    {
        return _connectionTestResult != null && 
               _connectionTestResult.Success &&
               _discoveredScripts != null && 
               _discoveredScripts.Any();
    }

    private async Task StartDatabaseCreation()
    {
        if (!CanStartCreation())
        {
            Snackbar.Add("Please complete previous steps", Severity.Warning);
            return;
        }

        _isCreatingDatabase = true;
        _creationProgress = 0;
        _currentCompletedScripts = 0;
        _successfulScripts = 0;
        _failedScripts = 0;
        _creationLog = string.Empty;
        _creationResult = null;
        _executionId = Guid.NewGuid().ToString();

        try
        {
            var config = BuildConnectionConfig();
            
            // Build selected script types
            var selectedScriptTypes = _availableScriptTypes?
                .Where(st => st.IsSelected)
                .Select(st => st.Name)
                .ToList() ?? new List<string>();

            var request = new CreateDatabaseRequest
            {
                Connection = config,
                Options = new DatabaseCreationOptionsDto
                {
                    DatabaseType = _selectedDatabaseType ?? string.Empty,
                    ExecuteAllScripts = _executeAllScripts,
                    ExecuteConsolidatedScripts = _executeConsolidatedScripts,
                    ExecuteIndividualScripts = _executeIndividualScripts,
                    ExecuteOptionalScripts = _executeOptionalScripts,
                    ContinueOnError = _continueOnError,
                    EnableRollback = _enableRollback,
                    ScriptTypes = selectedScriptTypes,
                    ExecutionId = _executionId,
                    EnableLogging = true
                }
            };

            // Start progress polling
            _progressTimer = new System.Threading.Timer(async _ => await PollProgress(), null, 1000, 2000);

            // Start creation (this will run asynchronously)
            _creationResult = await ApiClient.PostAsync<CreateDatabaseRequest, DatabaseCreationResultDto>(
                "/api/ppdm39/setup/create-database", request);

            _progressTimer?.Dispose();
            _progressTimer = null;

            if (_creationResult?.Success == true)
            {
                Snackbar.Add("Database created successfully!", Severity.Success);
                _creationProgress = 100;
            }
            else
            {
                Snackbar.Add($"Database creation failed: {_creationResult?.ErrorMessage}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _progressTimer?.Dispose();
            _progressTimer = null;
            Snackbar.Add($"Error creating database: {ex.Message}", Severity.Error);
            _creationResult = new DatabaseCreationResultDto
            {
                Success = false,
                ErrorMessage = ex.Message
            };
        }
        finally
        {
            _isCreatingDatabase = false;
        }
    }

    private async Task PollProgress()
    {
        if (string.IsNullOrEmpty(_executionId))
            return;

        try
        {
            var progress = await ApiClient.GetAsync<ScriptExecutionProgressDto>(
                $"/api/ppdm39/setup/creation-progress/{_executionId}");

            if (progress != null)
            {
                _creationProgress = progress.ProgressPercentage;
                _currentCompletedScripts = progress.CompletedScripts;
                _totalScripts = progress.TotalScripts;
                _currentScript = progress.CurrentScript;
                _successfulScripts = progress.CompletedScripts - progress.FailedScripts;
                _failedScripts = progress.FailedScripts;

                if (progress.Status == "Completed" || progress.Status == "Failed")
                {
                    _progressTimer?.Dispose();
                    _progressTimer = null;
                }

                StateHasChanged();
            }
        }
        catch
        {
            // Ignore polling errors
        }
    }

    private async Task SaveConnection()
    {
        _isSavingConnection = true;
        _saveResult = null;

        try
        {
            var config = BuildConnectionConfig();
            var saveRequest = new SaveConnectionRequest
            {
                Connection = config,
                TestAfterSave = false,
                OpenAfterSave = _setAsCurrent
            };

            _saveResult = await ApiClient.PostAsync<SaveConnectionRequest, SaveConnectionResult>(
                "/api/ppdm39/setup/save-connection", saveRequest);

            if (_saveResult?.Success == true)
            {
                Snackbar.Add("Connection saved successfully", Severity.Success);
                
                if (_setAsCurrent)
                {
                    // Set as current connection
                    var setCurrentRequest = new SetCurrentDatabaseRequest
                    {
                        ConnectionName = _connectionName
                    };
                    await ApiClient.PostAsync<SetCurrentDatabaseRequest, SetCurrentDatabaseResult>(
                        "/api/ppdm39/setup/set-current-connection", setCurrentRequest);
                }
            }
            else
            {
                Snackbar.Add($"Failed to save connection: {_saveResult?.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving connection: {ex.Message}", Severity.Error);
            _saveResult = new SaveConnectionResult
            {
                Success = false,
                Message = ex.Message
            };
        }
        finally
        {
            _isSavingConnection = false;
        }
    }

    private void NavigateToDatabaseManagement()
    {
        NavigationManager.NavigateTo("/ppdm39/database-management");
    }

    private void GoToPreviousStep()
    {
        if (_activeStep > 0)
            _activeStep--;
    }

    private void GoToNextStep()
    {
        if (CanProceedToNextStep())
        {
            if (_activeStep == 1 && _connectionTestResult?.Success == true)
            {
                // Auto-load scripts when moving to step 3
                _ = LoadScripts();
            }
            _activeStep++;
        }
    }

    private bool CanProceedToNextStep()
    {
        return _activeStep switch
        {
            0 => !string.IsNullOrEmpty(_selectedDatabaseType),
            1 => _connectionTestResult != null && _connectionTestResult.Success,
            2 => _discoveredScripts != null && _discoveredScripts.Any(),
            3 => _creationResult != null && _creationResult.Success,
            4 => _saveResult != null && _saveResult.Success,
            _ => false
        };
    }

    // Helper classes
    private class ScriptCategoryDto
    {
        public string CategoryName { get; set; } = string.Empty;
        public int ScriptCount { get; set; }
        public bool IsSelected { get; set; }
    }

    private class ScriptTypeDto
    {
        public string Name { get; set; } = string.Empty;
        public bool IsSelected { get; set; }
    }
}








