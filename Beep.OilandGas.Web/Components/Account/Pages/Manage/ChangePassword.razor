@page "/Account/Manage/ChangePassword"

@inject IAccountManagementService AccountService
@inject ISnackbar Snackbar

<PageTitle>Change Password - Beep Oil & Gas</PageTitle>

<MudText Typo="Typo.h4" Class="mb-2" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-text-primary);">
    <span style="color: var(--mud-palette-success);">$</span> passwd --change
</MudText>
<MudText Typo="Typo.body2" Class="mb-6" Style="color: var(--mud-palette-text-secondary);">
    Change your account password
</MudText>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Success" Indeterminate="true" />
}
else if (!hasPassword)
{
    <MudAlert Severity="Severity.Info" Class="mb-4">
        You don't have a password set. This happens when you registered using an external login provider.
    </MudAlert>
    
    <MudText Typo="Typo.h6" Class="mb-4" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-text-primary);">
        Set Password
    </MudText>
    
    <MudForm @ref="setPasswordForm" @bind-IsValid="@isSetPasswordValid">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="newPassword" 
                              Label="New Password" 
                              Variant="Variant.Outlined"
                              InputType="@(showNewPassword ? InputType.Text : InputType.Password)"
                              Required="true"
                              RequiredError="Password is required"
                              Style="background: var(--mud-palette-dark);"
                              Class="mb-4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(showNewPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => showNewPassword = !showNewPassword)" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="confirmPassword" 
                              Label="Confirm Password" 
                              Variant="Variant.Outlined"
                              InputType="@(showConfirmPassword ? InputType.Text : InputType.Password)"
                              Required="true"
                              RequiredError="Confirm password is required"
                              Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                              Style="background: var(--mud-palette-dark);"
                              Class="mb-4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => showConfirmPassword = !showConfirmPassword)" />
            </MudItem>
            
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Success" 
                           OnClick="SetPasswordAsync"
                           Disabled="@(!isSetPasswordValid || isSaving)"
                           StartIcon="@Icons.Material.Filled.Lock"
                           Style="font-family: 'JetBrains Mono', monospace;">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    set_password()
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
}
else
{
    <MudForm @ref="changePasswordForm" @bind-IsValid="@isChangePasswordValid">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="currentPassword" 
                              Label="Current Password" 
                              Variant="Variant.Outlined"
                              InputType="@(showCurrentPassword ? InputType.Text : InputType.Password)"
                              Required="true"
                              RequiredError="Current password is required"
                              Style="background: var(--mud-palette-dark);"
                              Class="mb-4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(showCurrentPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => showCurrentPassword = !showCurrentPassword)" />
            </MudItem>
            
            <MudItem xs="12" md="6"></MudItem>
            
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="newPassword" 
                              Label="New Password" 
                              Variant="Variant.Outlined"
                              InputType="@(showNewPassword ? InputType.Text : InputType.Password)"
                              Required="true"
                              RequiredError="New password is required"
                              Style="background: var(--mud-palette-dark);"
                              Class="mb-4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(showNewPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => showNewPassword = !showNewPassword)" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="confirmPassword" 
                              Label="Confirm New Password" 
                              Variant="Variant.Outlined"
                              InputType="@(showConfirmPassword ? InputType.Text : InputType.Password)"
                              Required="true"
                              RequiredError="Confirm password is required"
                              Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                              Style="background: var(--mud-palette-dark);"
                              Class="mb-4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(showConfirmPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => showConfirmPassword = !showConfirmPassword)" />
            </MudItem>
            
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Success" 
                           OnClick="ChangePasswordAsync"
                           Disabled="@(!isChangePasswordValid || isSaving)"
                           StartIcon="@Icons.Material.Filled.Lock"
                           Style="font-family: 'JetBrains Mono', monospace;">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    change_password()
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
}

@code {
    private MudForm? changePasswordForm;
    private MudForm? setPasswordForm;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool hasPassword = true;
    private bool isChangePasswordValid = false;
    private bool isSetPasswordValid = false;
    
    private string currentPassword = string.Empty;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    
    private bool showCurrentPassword = false;
    private bool showNewPassword = false;
    private bool showConfirmPassword = false;

    protected override async Task OnInitializedAsync()
    {
        hasPassword = await AccountService.HasPasswordAsync();
        isLoading = false;
    }

    private string? ValidateConfirmPassword(string value)
    {
        if (value != newPassword)
            return "Passwords do not match";
        return null;
    }

    private async Task ChangePasswordAsync()
    {
        isSaving = true;
        var result = await AccountService.ChangePasswordAsync(currentPassword, newPassword);
        isSaving = false;

        if (result.IsSuccess)
        {
            Snackbar.Add("Password changed successfully!", Severity.Success);
            currentPassword = string.Empty;
            newPassword = string.Empty;
            confirmPassword = string.Empty;
        }
        else
        {
            foreach (var error in result.Errors)
            {
                Snackbar.Add(error, Severity.Error);
            }
        }
    }

    private async Task SetPasswordAsync()
    {
        isSaving = true;
        var result = await AccountService.SetPasswordAsync(newPassword);
        isSaving = false;

        if (result.IsSuccess)
        {
            Snackbar.Add("Password set successfully!", Severity.Success);
            hasPassword = true;
            newPassword = string.Empty;
            confirmPassword = string.Empty;
        }
        else
        {
            foreach (var error in result.Errors)
            {
                Snackbar.Add(error, Severity.Error);
            }
        }
    }
}

