@using Beep.OilandGas.PPDM39.Core.Tree
@using MudBlazor

<div Class="pa-2">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudTextField Value="@_searchText" 
                      ValueChanged="EventCallback.Factory.Create<string>(this, OnSearchTextChanged)"
                      Label="Search Tables"
                      Variant="Variant.Outlined"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      Class="flex-grow-1" />
        @if (!string.IsNullOrWhiteSpace(_searchText))
        {
            <MudIconButton Icon="@Icons.Material.Filled.Clear" 
                          OnClick="ClearSearch"
                          Size="Size.Small"
                          Color="Color.Default" />
        }
    </MudStack>
    
    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-2" />
    }
    else if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="my-2">
            @_errorMessage
        </MudAlert>
    }
    else if (_treeItemData.Count == 0 && !string.IsNullOrWhiteSpace(_searchText))
    {
        <MudAlert Severity="Severity.Info" Class="my-2">
            No tables found matching "@_searchText"
        </MudAlert>
    }
    else if (_treeItemData.Count == 0)
    {
        <MudAlert Severity="Severity.Warning" Class="my-2">
            No data available. Check that PPDM39Metadata.json and PPDM39SubjectAreasAndModules.json are accessible.
        </MudAlert>
    }
    else
    {
        <MudTreeView Items="@_treeItemData" 
                     SelectedValue="_selectedTableId"
                     SelectedValueChanged="EventCallback.Factory.Create<string?>(this, OnSelectionChanged)"
                     SelectionMode="SelectionMode.SingleSelection"
                     Hover="true"
                     Dense="true"
                     @ref="_treeView"
                     FilterFunc="@MatchesSearch">
            <ItemTemplate>
                <MudTreeViewItem @bind-Expanded="@context.Expanded" 
                                 Items="@context.Children" 
                                 Value="@context.Value"
                                 Icon="@context.Icon" 
                                 IconExpanded="@GetExpandedIcon(context)"
                                 Text="@GetDisplayText(context)"
                                 Visible="@context.Visible" />
            </ItemTemplate>
        </MudTreeView>
    }
</div>

@code {
    private PPDMTreeNode? _rootNode;
    private List<TreeItemData<string?>> _treeItemData = new();
    private string _searchText = string.Empty;
    private bool _isLoading = false;
    private string? _selectedTableId;
    private MudTreeView<string?>? _treeView;
    private Dictionary<string, PPDMTreeNode> _nodeMap = new();

    [Parameter] public EventCallback<PPDMTreeNode> OnTableSelected { get; set; }
    [Inject] IPPDMTreeBuilder TreeBuilder { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await LoadTree();
    }


    private string? _errorMessage;

    private async Task LoadTree()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            _rootNode = await TreeBuilder.BuildTreeAsync(includeRelationships: false, includeColumns: false);
            if (_rootNode != null)
            {
                SetAllNodesVisible(_rootNode);
                _treeItemData = ConvertToTreeItemData(_rootNode.Children);
                
                if (_treeItemData.Count == 0)
                {
                    _errorMessage = "Tree built successfully but no subject areas found. Check metadata configuration.";
                }
            }
            else
            {
                _errorMessage = "Failed to build tree: TreeBuilder returned null.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading tree: {ex.Message}";
            if (ex.InnerException != null)
            {
                _errorMessage += $" Inner: {ex.InnerException.Message}";
            }
            Console.WriteLine($"Error loading tree: {ex}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void SetAllNodesVisible(PPDMTreeNode node)
    {
        node.IsVisible = true;
        foreach (var child in node.Children)
        {
            SetAllNodesVisible(child);
        }
    }

    private List<TreeItemData<string?>> ConvertToTreeItemData(List<PPDMTreeNode> nodes)
    {
        var result = new List<TreeItemData<string?>>();
        foreach (var node in nodes.Where(n => n.IsVisible))
        {
            var treeItem = ConvertNodeToTreeItem(node);
            if (treeItem != null)
            {
                result.Add(treeItem);
            }
        }
        return result;
    }

    private TreeItemData<string?>? ConvertNodeToTreeItem(PPDMTreeNode node)
    {
        // Only include Subject Areas, Modules, Subcategories, and Tables
        if (node.NodeType == PPDMTreeNodeType.Root || 
            node.NodeType == PPDMTreeNodeType.Relationship ||
            node.NodeType == PPDMTreeNodeType.PrimaryKey ||
            node.NodeType == PPDMTreeNodeType.Column)
        {
            return null;
        }

        var nodeId = node.Id ?? Guid.NewGuid().ToString();
        _nodeMap[nodeId] = node;

        var treeItem = new TreeItemData<string?>
        {
            Value = nodeId,
            Text = node.Text,
            Icon = GetIcon(node.NodeType),
            Expanded = node.IsExpanded,
            Visible = node.IsVisible,
            Children = ConvertToTreeItemData(node.Children)
        };

        return treeItem;
    }

    private async Task OnSearchTextChanged(string searchText)
    {
        _searchText = searchText;
        if (_treeView != null)
        {
            await _treeView.FilterAsync();
        }
    }

    private async Task ClearSearch()
    {
        _searchText = string.Empty;
        if (_treeView != null)
        {
            await _treeView.FilterAsync();
        }
    }

    private Task<bool> MatchesSearch(TreeItemData<string?> item)
    {
        if (string.IsNullOrWhiteSpace(_searchText))
        {
            return Task.FromResult(true);
        }

        if (string.IsNullOrEmpty(item.Text))
        {
            return Task.FromResult(false);
        }

        // Check if the item itself matches
        if (item.Text.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
        {
            return Task.FromResult(true);
        }

        // Check if any child matches (if so, show parent)
        if (item.Children != null && item.Children.Any())
        {
            foreach (var child in item.Children)
            {
                if (MatchesSearch(child).Result)
                {
                    return Task.FromResult(true);
                }
            }
        }

        return Task.FromResult(false);
    }

    private string GetDisplayText(TreeItemData<string?> item)
    {
        if (item.Value == null || !_nodeMap.TryGetValue(item.Value, out var node))
        {
            return item.Text ?? string.Empty;
        }

        // Add count for modules and subject areas
        if (node.NodeType == PPDMTreeNodeType.Module || node.NodeType == PPDMTreeNodeType.SubjectArea)
        {
            if (node.Data != null && node.Data.TryGetValue("TableCount", out var tableCount))
            {
                var count = tableCount?.ToString() ?? "0";
                return $"{node.Text} ({count})";
            }
        }

        return node.Text;
    }

    private string GetExpandedIcon(TreeItemData<string?> item)
    {
        if (item.Value == null || !_nodeMap.TryGetValue(item.Value, out var node))
        {
            return GetIcon(PPDMTreeNodeType.Module);
        }

        // Use folder open icon when expanded for folders
        if (node.NodeType == PPDMTreeNodeType.SubjectArea || node.NodeType == PPDMTreeNodeType.Module)
        {
            return Icons.Material.Filled.FolderOpen;
        }

        return GetIcon(node.NodeType);
    }

    private string GetIcon(PPDMTreeNodeType nodeType)
    {
        return nodeType switch
        {
            PPDMTreeNodeType.Root => Icons.Material.Filled.Storage,
            PPDMTreeNodeType.SubjectArea => Icons.Material.Filled.Folder,
            PPDMTreeNodeType.Module => Icons.Material.Filled.FolderOpen,
            PPDMTreeNodeType.Subcategory => Icons.Material.Filled.Category,
            PPDMTreeNodeType.Table => Icons.Material.Filled.TableChart,
            PPDMTreeNodeType.Relationship => Icons.Material.Filled.Link,
            PPDMTreeNodeType.PrimaryKey => Icons.Material.Filled.VpnKey,
            PPDMTreeNodeType.Column => Icons.Material.Filled.ViewColumn,
            _ => Icons.Material.Filled.Circle
        };
    }

    private async Task OnSelectionChanged(string? selectedId)
    {
        _selectedTableId = selectedId;
        await HandleSelection(selectedId);
    }

    private async Task HandleSelection(string? selectedId)
    {
        if (string.IsNullOrWhiteSpace(selectedId))
        {
            Console.WriteLine("PPDMTreeView: HandleSelection - selectedId is null or empty");
            return;
        }

        if (!_nodeMap.TryGetValue(selectedId, out var node))
        {
            Console.WriteLine($"PPDMTreeView: HandleSelection - Node not found in map for ID: {selectedId}");
            return;
        }

        Console.WriteLine($"PPDMTreeView: HandleSelection - Node found: {node.Text}, Type: {node.NodeType}");
        
        if (node.NodeType == PPDMTreeNodeType.Table)
        {
            Console.WriteLine($"PPDMTreeView: Invoking OnTableSelected for table: {node.Text}");
            Console.WriteLine($"PPDMTreeView: OnTableSelected.HasDelegate = {OnTableSelected.HasDelegate}");
            
            if (OnTableSelected.HasDelegate)
            {
                await OnTableSelected.InvokeAsync(node);
                Console.WriteLine($"PPDMTreeView: OnTableSelected.InvokeAsync completed");
            }
            else
            {
                Console.WriteLine($"PPDMTreeView: ERROR - OnTableSelected has no delegate!");
            }
        }
        else
        {
            Console.WriteLine($"PPDMTreeView: Node is not a table, it's: {node.NodeType}");
        }
    }

}
