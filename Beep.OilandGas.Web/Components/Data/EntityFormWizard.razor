@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudContainer Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">@Title</MudText>
            
            <MudStepper @bind-ActiveStep="@_activeStep" Color="Color.Primary" Variant="Variant.Filled">
                @foreach (var step in _steps)
                {
                    <MudStep Title="@step.Title" Icon="@step.Icon">
                        <MudPaper Class="pa-4" Elevation="1">
                            @step.Content
                        </MudPaper>
                    </MudStep>
                }
            </MudStepper>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">Cancel</MudButton>
        @if (_activeStep > 0)
        {
            <MudButton Color="Color.Secondary" OnClick="@PreviousStep">Previous</MudButton>
        }
        @if (_activeStep < _steps.Count - 1)
        {
            <MudButton Color="Color.Primary" 
                      Variant="Variant.Filled" 
                      OnClick="@NextStep"
                      Disabled="@(!CanProceedToNextStep())">
                Next
            </MudButton>
        }
        else
        {
            <MudButton Color="Color.Primary" 
                      Variant="Variant.Filled" 
                      OnClick="@Save"
                      Disabled="@(_isSaving || !CanProceedToNextStep())">
                @if (_isSaving)
                {
                    <text>Saving...</text>
                }
                else
                {
                    <text>Save</text>
                }
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }
    [Parameter] public string Title { get; set; } = "Entity Form";
    [Parameter] public List<WizardStep> Steps { get; set; } = new();
    [Parameter] public EventCallback<Dictionary<string, object>> OnSave { get; set; }

    private List<WizardStep> _steps = new();
    private int _activeStep = 0;
    private bool _isSaving = false;
    private Dictionary<string, object> _formData = new();

    protected override void OnParametersSet()
    {
        _steps = Steps;
    }

    private void NextStep()
    {
        if (_activeStep < _steps.Count - 1)
        {
            _activeStep++;
        }
    }

    private void PreviousStep()
    {
        if (_activeStep > 0)
        {
            _activeStep--;
        }
    }

    private bool CanProceedToNextStep()
    {
        var currentStep = _steps.ElementAtOrDefault(_activeStep);
        return currentStep?.IsValid?.Invoke(_formData) ?? true;
    }

    private async Task Save()
    {
        _isSaving = true;
        StateHasChanged();

        try
        {
            await OnSave.InvokeAsync(_formData);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            // Error handling would be done by parent component
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    public class WizardStep
    {
        public string Title { get; set; } = string.Empty;
        public string? Icon { get; set; }
        public RenderFragment? Content { get; set; }
        public Func<Dictionary<string, object>, bool>? IsValid { get; set; }
    }
}

