@page "/account/dashboard"
@attribute [Authorize]
@inject IAccountManagementService AccountService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>My Account - Beep Oil & Gas</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0" Style="background: var(--mud-palette-background); min-height: 100vh;">
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
        <!-- Terminal Header -->
        <MudPaper Class="pa-4 mb-6" Elevation="0" Style="background: var(--mud-palette-surface); border: 1px solid var(--mud-palette-divider); border-radius: 8px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudStack Row="true" Spacing="1">
                    <div style="width: 12px; height: 12px; background: #ff5f56; border-radius: 50%;"></div>
                    <div style="width: 12px; height: 12px; background: #ffbd2e; border-radius: 50%;"></div>
                    <div style="width: 12px; height: 12px; background: #27c93f; border-radius: 50%;"></div>
                </MudStack>
                <MudText Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-text-secondary); font-size: 0.875rem; margin-left: 16px;">
                    ~/account <span style="color: var(--mud-palette-success);">$</span> cat dashboard.json | jq
                </MudText>
            </MudStack>
        </MudPaper>
        
        <MudText Typo="Typo.h3" Class="mb-2" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-text-primary);">
            <span style="color: var(--mud-palette-success);">const</span> <span style="color: var(--mud-palette-warning);">user_dashboard</span> <span style="color: var(--mud-palette-primary);">=</span> <span style="color: var(--mud-palette-secondary);">{"{"}</span>
        </MudText>
        <MudText Typo="Typo.subtitle1" Class="mb-6" Style="color: var(--mud-palette-text-secondary); font-family: 'JetBrains Mono', monospace;">
            // Welcome back! Here's an overview of your account
        </MudText>

    @if (isLoading)
    {
        <MudGrid>
            @for (int i = 0; i < 6; i++)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (profile == null)
    {
        <MudPaper Elevation="0" Class="pa-6" Style="background: var(--mud-palette-surface); border: 1px solid var(--mud-palette-error); border-radius: 8px;">
            <MudText Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-error);" Class="mb-4">
                // Error: Unable to load account information
            </MudText>
            <MudButton Variant="Variant.Filled" OnClick="LoadDashboard"
                       Style="font-family: 'JetBrains Mono', monospace;">
                retry()
            </MudButton>
        </MudPaper>
    }
    else
    {
        <!-- Stats Cards -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="0" Class="h-100" Style="background: var(--mud-palette-surface); border: 1px solid var(--mud-palette-divider); border-radius: 8px;">
                    <MudCardContent Class="d-flex align-center">
                        <MudAvatar Size="Size.Large" Class="mr-4" Style="background: linear-gradient(135deg, var(--mud-palette-success) 0%, var(--mud-palette-success-darken) 100%);">
                            <MudIcon Icon="@Icons.Material.Filled.AccountCircle" />
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.h4" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-success); font-weight: bold;">
                                @(profile.EmailConfirmed ? "Verified" : "Unverified")
                            </MudText>
                            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary); font-family: 'JetBrains Mono', monospace;">
                                email_status
                            </MudText>
                        </div>
                    </MudCardContent>
                    <MudCardActions Style="border-top: 1px solid var(--mud-palette-divider);">
                        <MudButton Variant="Variant.Text" Href="/Account/Manage/Email" Style="color: var(--mud-palette-primary); font-family: 'JetBrains Mono', monospace;">
                            manage_email()
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="0" Class="h-100" Style="background: var(--mud-palette-surface); border: 1px solid var(--mud-palette-divider); border-radius: 8px;">
                    <MudCardContent Class="d-flex align-center">
                        <MudAvatar Size="Size.Large" Class="mr-4" Style="background: linear-gradient(135deg, var(--mud-palette-info) 0%, var(--mud-palette-info-darken) 100%);">
                            <MudIcon Icon="@Icons.Material.Filled.Security" />
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.h4" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-info); font-weight: bold;">
                                @(profile.TwoFactorEnabled ? "Enabled" : "Disabled")
                            </MudText>
                            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary); font-family: 'JetBrains Mono', monospace;">
                                two_factor_auth
                            </MudText>
                        </div>
                    </MudCardContent>
                    <MudCardActions Style="border-top: 1px solid var(--mud-palette-divider);">
                        <MudButton Variant="Variant.Text" Href="/Account/Manage/TwoFactorAuthentication" Style="color: var(--mud-palette-primary); font-family: 'JetBrains Mono', monospace;">
                            manage_2fa()
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="0" Class="h-100" Style="background: var(--mud-palette-surface); border: 1px solid var(--mud-palette-divider); border-radius: 8px;">
                    <MudCardContent Class="d-flex align-center">
                        <MudAvatar Size="Size.Large" Class="mr-4" Style="background: linear-gradient(135deg, var(--mud-palette-secondary) 0%, var(--mud-palette-secondary-darken) 100%);">
                            <MudIcon Icon="@Icons.Material.Filled.Link" />
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.h4" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-secondary); font-weight: bold;">
                                @externalLoginsCount
                            </MudText>
                            <MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary); font-family: 'JetBrains Mono', monospace;">
                                external_logins
                            </MudText>
                        </div>
                    </MudCardContent>
                    <MudCardActions Style="border-top: 1px solid var(--mud-palette-divider);">
                        <MudButton Variant="Variant.Text" Href="/Account/Manage/ExternalLogins" Style="color: var(--mud-palette-primary); font-family: 'JetBrains Mono', monospace;">
                            manage_logins()
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Quick Actions -->
        <MudPaper Elevation="0" Class="pa-4 mb-6" Style="background: var(--mud-palette-surface); border: 1px solid var(--mud-palette-divider); border-radius: 8px;">
            <MudText Typo="Typo.h5" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-text-primary);" Class="mb-4">
                <span style="color: var(--mud-palette-primary);">quick_actions</span><span style="color: var(--mud-palette-warning);">[]</span>
            </MudText>
            
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true"
                               Href="/Account/Manage"
                               StartIcon="@Icons.Material.Filled.Person"
                               Style="font-family: 'JetBrains Mono', monospace;">
                        edit_profile()
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true"
                               Href="/Account/Manage/ChangePassword"
                               StartIcon="@Icons.Material.Filled.Lock"
                               Style="font-family: 'JetBrains Mono', monospace;">
                        change_password()
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true"
                               Href="/Account/Manage/PersonalData"
                               StartIcon="@Icons.Material.Filled.Download"
                               Style="font-family: 'JetBrains Mono', monospace;">
                        download_data()
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Error"
                               FullWidth="true"
                               Href="/Account/Manage/PersonalData"
                               StartIcon="@Icons.Material.Filled.Delete"
                               Style="font-family: 'JetBrains Mono', monospace;">
                        delete_account()
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
        
        <MudText Typo="Typo.body2" Class="mt-4" Style="font-family: 'JetBrains Mono', monospace; color: var(--mud-palette-text-secondary);">
            <span style="color: var(--mud-palette-secondary);">{"}"}</span>
        </MudText>
    }
    </MudContainer>
</MudContainer>

@code {
    private UserProfile? profile;
    private bool isLoading = true;
    private int externalLoginsCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboard();
    }

    private async Task LoadDashboard()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            profile = await AccountService.GetProfileAsync();
            
            // Get external logins count
            var loginsInfo = await AccountService.GetExternalLoginsAsync();
            externalLoginsCount = loginsInfo?.CurrentLogins.Count ?? 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}

